## Дисковая подсистема


### <a name='toc'>Содержание</a>

1. [Задачи дисковой системы](#1)
2. [Программный и аппаратный RAID 0/1/5/6/10/60](#2)
3. [Информация о дисковой подсистеме - dmidecode, dmesg, smartctl](#3)
4. [Собрать программный RAID](#4)
5. [Восстановить RAID после сбоя](#5)
6. [MBR и GPT. Команды gdisk/fdisk/parted/partprobe](#6)
7. [Лабораторная работа](#7)
8. [Рекомендуемые источники](#recommended_sources)


<br>

**<a name='1'>Задачи дисковой системы</a>**

В Linux дисковая система (блочные устройства, файловые системы, менеджеры томов) выполняет следующие ключевые задачи:

**1. Управление блочными устройствами**

- Поддержка HDD, SSD, NVMe, USB-накопителей, сетевых хранилищ (iSCSI, NFS).
- Работа с разделами (`/dev/sda1`, `/dev/nvme0n1p2`).
- Инструменты: `fdisk`, `parted`, `lsblk`, `blkid`.

**2. Организация файловых систем**

- Форматирование и монтирование (`ext4`, `XFS`, `Btrfs`, `ZFS`).
- Автомонтирование (`/etc/fstab`).
- Проверка и восстановление (`fsck`, `xfs_repair`).

**3. Логическое управление дисками (LVM)**

- Создание и изменение томов (`pvcreate`, `vgcreate`, `lvresize`).
- "Горячее" добавление дисков, изменение размеров без отключения.
- Снапшоты (`lvcreate --snapshot`).

**4. Оптимизация производительности**

- Кэширование (через `bcache`, `dm-cache`).
- TRIM для SSD (`fstrim`).
- Настройка планировщика ввода-вывода (`deadline`, `noop`, `mq-deadline`).

**5. Надежность и мониторинг**

- Контроль состояния дисков (`smartctl` из пакета `smartmontools`).
- RAID (`mdadm` для программного `RAID`).
- Резервное копирование (`dd`, `rsync`, LVM-снапшоты).

**6. Безопасность**

- Шифрование (LUKS через `cryptsetup`).
- Разграничение прав доступа (стандартные Unix-права, `ACL`, `SELinux/AppArmor`).
- Защита от повреждений (журналирование в `ext4/XFS`).

**7. Сетевые и виртуальные хранилища**

- Подключение сетевых FS (`NFS`, `CIFS`).
- Виртуализация хранилищ (`DRBD`, `Ceph`).
- Контейнеры и overlay-ФС (aufs, `overlayfs`).

**Итог**: Дисковая подсистема Linux обеспечивает гибкость, отказоустойчивость и высокую производительность, поддерживая как классические `HDD`, так и современные `SSD/NVMe` с продвинутыми функциями (`LVM`, `RAID`, шифрование).



<br>

## <a name='2'>Программный и аппаратный RAID: уровни 0, 1, 5, 6, 10, 60</a>

RAID (Redundant Array of Independent Disks) — технология объединения дисков для повышения производительности, отказоустойчивости или обоих параметров.

**1. Аппаратный RAID**

**Что это?**
- Реализуется отдельным RAID-контроллером (например, от LSI, Adaptec).
- Не нагружает CPU, так как обработка RAID выполняется на контроллере.
- Часто имеет собственную память (кеш) и батарею (BBU) для защиты данных.

**Плюсы:**
- Высокая производительность (особенно при записи).
- Поддержка горячей замены (hot-swap) дисков.
- Независимость от ОС (работает до её загрузки).

**Минусы:**
- Дорогое оборудование.
- Зависимость от контроллера (при поломке возможны проблемы с переносом массива).


<hr>

**2. Программный RAID**

**Что это?**
- Управляется операционной системой (например, mdadm в Linux, Storage Spaces в Windows).
- Использует ресурсы CPU и RAM.

**Плюсы:**
- Бесплатно (не требует спецоборудования).
- Гибкость (легко перенести на другой компьютер).
- Поддержка в большинстве ОС.

**Минусы:**
- Нагрузка на процессор.
- Меньшая производительность при высоких нагрузках.
- Нет кеширования (если не используется дополнительное ПО).


<br>

### Виды RAID-массивов и их отличия

<br>

**1. RAID 0 (Stripe – чередование)**
**Принцип:** Данные разбиваются на блоки и записываются на несколько дисков параллельно.

**Минимум дисков:** 2.

**Преимущества:**
- Максимальная скорость чтения/записи (за счёт распараллеливания).
- 100% полезного места.

**Недостатки:**
- **Нет отказоустойчивости** – выход одного диска уничтожает весь массив.

**Где использовать:**
- Кэши, временные данные, игровые ПК (где важна скорость, но не сохранность).


<hr>

**2. RAID 1 (Mirror – зеркало)**

**Принцип:** Полное дублирование данных на 2+ дисках.

**Минимум дисков:** 2.

**Преимущества:**
- Высокая надёжность (работает, пока жив хотя бы один диск).
- Быстрое восстановление (простое копирование).

**Недостатки:**
- Только 50% полезного места (в 2-дисковой конфигурации).

**Где использовать:**
- Системные разделы, критически важные данные.


<hr>

**3. RAID 5 (Parity – чередование с чётностью)**

**Принцип:** Данные и контрольные суммы распределяются по всем дискам.

**Минимум дисков: 3.**

**Преимущества:**
- Оптимальный баланс скорости и надёжности.
- Эффективное использование места (N-1 дисков, где N – общее количество).

**Недостатки:**
- Медленная запись (из-за расчёта чётности).
- Риск потери данных при отказе 2+ дисков.

**Где использовать:**
- Файловые серверы, базы данных.


<hr>

**4. RAID 6 (Двойная чётность)**

**Принцип:** Как RAID 5, но с двумя контрольными суммами.

**Минимум дисков:** 4.

**Преимущества:**
- Выдерживает отказ двух дисков.

**Недостатки:**
- Ещё медленнее запись, чем в RAID 5.
- Больше накладных расходов (N-2 дисков).

**Где использовать:**
- Серверы с высокими требованиями к надёжности.


<hr>

**5. RAID 10 (1+0 – зеркало + чередование)**

**Принцип:** Сначала зеркалирование (RAID 1), затем чередование (RAID 0).

**Минимум дисков:** 4.

**Преимущества:**
- Высокая скорость + отказоустойчивость (можно потерять до половины дисков, если они из разных пар).

**Недостатки:**
- Только 50% полезного места.

**Где использовать:**
- Базы данных, виртуализация, высоконагруженные серверы.


<hr>

**6. RAID 50 (RAID 5 + RAID 0)**

**Принцип:** Несколько RAID 5 объединяются в RAID 0.

**Минимум дисков:** 6 (2 группы по 3).

**Преимущества:**
- Лучшая производительность, чем у RAID 5.
- Можно потерять по 1 диску в каждой группе.

**Недостатки:**
- Сложность восстановления.

**Где использовать:**
- Средние и крупные хранилища с балансом скорости и надёжности.


<hr>

**7. RAID 60 (RAID 6 + RAID 0)**

**Принцип:** Несколько RAID 6 объединяются в RAID 0.

**Минимум дисков:** 8 (2 группы по 4).

**Преимущества:**
- Максимальная надёжность (можно потерять по 2 диска в каждой группе).
- Высокая скорость чтения.

**Недостатки:**
- Очень большие накладные расходы (N-2 дисков).

**Где использовать:**
- Крупные хранилища, требующие максимальной отказоустойчивости.


**Вывод**

- Для скорости: RAID 0, 10, 50, 60.
- Для надёжности: RAID 1, 5, 6, 10, 60.
- Баланс: RAID 5, 10, 50.

Выбор зависит от требований к **производительности**, **надежности** и **бюджета**.



<br>

## <a name='3'>Получение информации о дисковой подсистеме в Linux</a>

Для диагностики и мониторинга дисковых накопителей (`HDD`, `SSD`, `NVMe`) в Linux используются следующие инструменты:

### 1. `dmidecode` – информация о железе (BIOS, дисках, RAID)

Показывает данные из `DMI/SMBIOS` (информация о производителе, модели, серийном номере).

**Основные команды:**

```ruby
sudo dmidecode -t memory       # Информация о RAM (может помочь в диагностике кэша RAID)  
sudo dmidecode -t disk         # Список дисков (не всегда полный)  
sudo dmidecode -t bios         # Информация о BIOS/UEFI  
sudo dmidecode -t system       # Данные о системе (сервер, материнская плата)  

```

**Вывод:**

- Модель диска, серийный номер (если поддерживается).
- Информация о RAID-контроллере (если есть аппаратный RAID).

**Ограничения:**

- Не показывает все диски (лучше использовать lsblk/fdisk).
- Для NVMe/SSD данные могут быть неполными.


### 2. `dmesg` – логи ядра (ошибки дисков, подключение устройств)

Содержит записи о **подключении дисков**, **ошибках**, **времени работы**.

**Полезные команды:**

```ruby
dmesg | grep -i sda           # Фильтр по конкретному диску (sda, nvme0n1)  
dmesg | grep -i scsi          # SATA/SAS-диски  
dmesg | grep -i ata           # ATA/SATA-устройства  
dmesg | grep -i error         # Ошибки дисков  
dmesg -T | grep -i "usb storage" # USB-накопители (с временем)  
```

**Что можно узнать:**

- Обнаружение/отключение дисков.
- Ошибки ввода-вывода (I/O error).
- Проблемы с файловой системой.
- Время работы диска (для SSD/NVMe).

```ruby
journalctl -k -b | grep -i sda  # Альтернатива (systemd)  
```


### 3. smartctl – проверка здоровья дисков (SMART)

Утилита для мониторинга `S.M.A.R.T.` (Self-Monitoring, Analysis and Reporting Technology).

**Установка:**

```ruby
sudo apt install smartmontools  # Debian/Ubuntu  
sudo yum install smartmontools # CentOS/RHEL  
```

**Основные команды:**

**1. Проверка поддержки SMART**

```ruby
sudo smartctl -i /dev/sda      # Информация о диске  
sudo smartctl -H /dev/sda      # Общее состояние здоровья  
```

**2. Подробные атрибуты SMART**

```ruby
sudo smartctl -A /dev/sda      # Все атрибуты (температура, ошибки чтения/записи)  
sudo smartctl -x /dev/nvme0n1  # Расширенная информация (для NVMe)  
```

**3. Запуск тестов**

```ruby
sudo smartctl -t short /dev/sda    # Быстрый тест (2-5 мин)  
sudo smartctl -t long /dev/sda     # Полный тест (несколько часов)  
sudo smartctl -l selftest /dev/sda # Просмотр результатов теста  
```

**4. Проверка SSD/NVMe**

```ruby
sudo smartctl -a /dev/nvme0n1  # Вся информация (износ, оставшийся ресурс)  
```

**Ключевые параметры SMART:**

```ruby
Reallocated Sectors	#Переназначенные сектора (чем больше – тем хуже)
Power_On_Hours	#Время работы (в часах)
Temperature	#Текущая температура
Media_Wearout_Indicator	#Оставшийся ресурс SSD (в %)
UDMA_CRC_Error_Count	#Ошибки передачи данных (проблемы с кабелем)
```

**Критические ошибки:**

```ruby
`Current_Pending_Sector` # битые сектора, требующие переназначения.
`Uncorrectable_Error_Count` # неустранимые ошибки.
```

**4. Дополнительные утилиты**

**lsblk** – список дисков и разделов

```ruby
lsblk -o NAME,SIZE,FSTYPE,MOUNTPOINT,ROTA  
```
`ROTA=1` – HDD, `ROTA=0` – SSD/NVMe.

**hdparm** – тест скорости диска

```ruby
sudo hdparm -Tt /dev/sda  
```

**badblocks – поиск битых секторов**

```ruby
sudo badblocks -v /dev/sda  
```

**Вывод**
| Инструмент | Что показывает | Когда использовать |
| ------- | ----------- | ----------- |
| `dmidecode` |	Аппаратная информация (BIOS, RAID) | Поиск модели диска, контроллера |
| `dmesg` | Логи ядра (ошибки дисков) | Диагностика проблем при загрузке |
| `smartctl` | S.M.A.R.T.-данные (здоровье диска) | Проверка на битые сектора, износ SSD |
| `lsblk/fdisk` | Список дисков и разделов | Настройка файловых систем |

**Пример диагностики:**

```ruby
# Проверить список дисков
lsblk
```

```ruby
# Узнать модель и SMART-статус
sudo smartctl -i /dev/sda && sudo smartctl -H /dev/sda
```

```ruby
# Поиск ошибок в логах
dmesg | grep -i error
```

Если `smartctl` показывает ошибки – **срочно делайте бэкап** и замените диск!




<br>

### <a name='recommended_sources'>Рекомендуемые источники</a>

- [*********************](https://kernel.ubuntu.com/mainline/)
